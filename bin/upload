#! /usr/bin/env bash

if [ -z "${VAR+x}" ] || ( [ "${TRAVIS_BRANCH}" = "master" ] && [ "${TRAVIS_PULL_REQUEST}" = "false" ] ); then
  tag=$(git describe --tags --abbrev=0 || echo "0.0")
  count=$(git rev-list --count HEAD ^"${tag}" || git rev-list --count HEAD)
  cd rockspec || exit 1
  for rockspec in *-master-1.rockspec; do
    name=${rockspec%%-master-1.rockspec}
    sed -e "s/master-1/${tag}-${count}/" "${rockspec}" > "${name}"-"${tag}"-"${count}".rockspec
    echo luarocks upload "${name}"-"${tag}"-"${count}".rockspec --api-key=${LUAROCKS_API_KEY}
  done
  cd ..
fi
